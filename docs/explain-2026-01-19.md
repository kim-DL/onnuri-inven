# EXPLAIN Evidence — 2026-01-19

## How to run

- Use Supabase SQL Editor. Copy each `EXPLAIN (ANALYZE, BUFFERS)` block and run as-is.
- Replace `:product_id` with a real UUID before running Pattern C.

---

## Pattern A — Active products list (name order)

Reproduction query (matches `/products` list fetch):

```sql
select id, name, manufacturer, zone_id, expiry_date, photo_url, unit
from public.products
where active = true
order by name;
```

EXPLAIN BEFORE (current indexes):

```sql
explain (analyze, buffers)
select id, name, manufacturer, zone_id, expiry_date, photo_url, unit
from public.products
where active = true
order by name;
```

EXPLAIN output (BEFORE): (awaiting SQL Editor output)

Interpretation:

- Expect sequential scan + sort without a supporting `(active, name)` index; high rows will spill to disk.
- AFTER applying `idx_products_active_name_partial` (see patch), re-run to confirm index scan with ordered output and reduced sort cost.
- Check buffer hits vs reads to gauge cache residency for the catalog table.

EXPLAIN output (AFTER index patch): (awaiting SQL Editor output)

---

## Pattern B — Archived products list (archived page, name order)

Reproduction query (matches `ArchivedProductsClient` products fetch; inventory is fetched separately):

```sql
select
  id,
  name,
  manufacturer,
  zone_id
from public.products
where active = false
order by name;
```

EXPLAIN BEFORE (current indexes):

```sql
explain (analyze, buffers)
select
  id,
  name,
  manufacturer,
  zone_id
from public.products
where active = false
order by name;
```

EXPLAIN output (BEFORE): (awaiting SQL Editor output)

Interpretation:

- Current indexes lack coverage for `active=false` ordering by name; expect filter + sort on `products`.
- AFTER applying `idx_products_inactive_name_partial` (see patch), re-run to confirm index scan on inactive rows with ordered output.
- Inventory and zones are fetched via separate queries; no joins in this path.

EXPLAIN output (AFTER index patch): (awaiting SQL Editor output)

---

## Pattern C — Inventory logs by product (recent first)

Reproduction query (matches `get_inventory_logs_for_product` usage, limit 50):

```sql
select id, created_at, delta, before_stock, after_stock, note, created_by
from public.inventory_logs
where product_id = :product_id
order by created_at desc
limit 50;
```

EXPLAIN to run:

```sql
explain (analyze, buffers)
select id, created_at, delta, before_stock, after_stock, note, created_by
from public.inventory_logs
where product_id = :product_id
order by created_at desc
limit 50;
```

EXPLAIN output (BEFORE): (awaiting SQL Editor output)

Interpretation:

- Should use existing `idx_logs_product_created_at (product_id, created_at desc)` for an index scan with `Limit` on the index order.
- Check for `Rows Removed by Filter` to ensure the predicate is pushed into the index scan (it should be).
- Buffers should be mostly hits; any significant reads suggest growth requiring maintenance or further indexing.

EXPLAIN output (AFTER index patch): (awaiting SQL Editor output)

---

## AFTER INDEX PATCH (pending SQL Editor run)

Re-run all EXPLAIN blocks above after applying `db/patches/2026-01-19_opt_indexes.sql` in SQL Editor. Capture outputs as “EXPLAIN output (AFTER)” under each pattern. Current outputs remain pending because SQL Editor access is not available in this environment.
