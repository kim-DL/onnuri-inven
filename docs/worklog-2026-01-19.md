# Worklog — 2026-01-19 (SSOT)

## Executive Summary

- Objective: validate Supabase contract (RLS/RPC), surface DB read/write patterns, and prepare safe optimizations without breaking contract constraints.
- Contract verification: all RPCs used in code exist (including `admin_set_user_display_name`, `get_inventory_logs_for_product`); RLS enforces `is_active_user` for reads/writes; `adjust_stock` guards against inactive products and negative stock. Repair Gate: NOT REQUIRED.
- Evidence: RPC/table scan, RLS/functional definitions, and index inventory consolidated here; EXPLAIN BEFORE/AFTER and index application are pending SQL Editor runs. Smoke tests not run.
- DB changes: draft index patch (`db/patches/2026-01-19_opt_indexes.sql`) prepared but not applied.
- Risks/next steps: run SQL Editor for EXPLAIN + apply index patch, then rerun EXPLAIN AFTER and execute smoke checklist.

## Scope & Guardrails

- Do Not Break Contract: no RPC signature/return changes, no column renames, no RLS scope changes, no direct inventory stock updates (use `adjust_stock`).
- In scope: Task A/B/C/D evidence, missing-RPC verification, EXPLAIN templates, index patch plan, smoke checklist.
- Out of scope edits: product code/UI unchanged; only documentation and index patch draft.

## Contract Verification

- Missing RPCs verified: `admin_set_user_display_name` (auth + active + admin; updates `users_profile.display_name`); `get_inventory_logs_for_product` (auth + active; returns recent logs with actor name, limit capped). Both definitions captured from SQL Editor output.
- RLS: `products`, `inventory`, `inventory_logs`, `zones`, `app_settings` all gated by `is_active_user`; admin-only policies on `users_profile` admin operations and `zones` writes.
- Critical RPC behavior: `adjust_stock` checks auth + `is_active_user`, requires active product, locks inventory row, prevents negative stock, logs to `inventory_logs`.
- Repair Gate: NOT REQUIRED (admin RPCs respect active users; stock guard present).

## Evidence & EXPLAIN (BEFORE/AFTER)

- Pattern A (Active list `/products`): `select ... from products where active=true order by name;`  
  - BEFORE EXPLAIN: awaiting SQL Editor output.  
  - AFTER EXPLAIN (post-index): awaiting SQL Editor output. Expect index scan once `idx_products_active_name_partial` exists.
- Pattern B (Archived list `/products/archived`): `select id,name,manufacturer,zone_id from products where active=false order by name;`  
  - BEFORE EXPLAIN: awaiting SQL Editor output.  
  - AFTER EXPLAIN: awaiting SQL Editor output. Expect index scan once `idx_products_inactive_name_partial` exists.
- Pattern C (Inventory logs): `select ... from inventory_logs where product_id=:id order by created_at desc limit 50;`  
  - BEFORE EXPLAIN: awaiting SQL Editor output; should use `idx_logs_product_created_at`.  
  - AFTER EXPLAIN: awaiting SQL Editor output (no index change expected).
- Action: run EXPLAIN (ANALYZE, BUFFERS) in Supabase SQL Editor before/after applying the index patch and paste outputs under the corresponding slots above.

## Changes Applied to DB

- Index patch drafted but NOT applied (needs SQL Editor): `db/patches/2026-01-19_opt_indexes.sql`
  - `create index if not exists idx_products_active_name_partial on public.products(name) where active=true;`
  - `create index if not exists idx_products_active_zone_name_partial on public.products(zone_id, name) where active=true;`
  - `create index if not exists idx_products_inactive_name_partial on public.products(name) where active=false;`
- No repair patch created (gate not triggered).

## Smoke Test

- Status: NOT RUN (run by QA/maintainer in staging or minimal prod smoke after DB patch).
- Checklist: login gate; products list load; product detail load; adjust_stock modal IN/OUT updates stock and logs; archived list load/restore/delete flows; settings expiry_warning_days update (admin only).

## Timeline (snapshots)

- 20:42 @ a4b7e62 — Initial snapshot, worklog created.
- 20:51 @ e04040e — Branch state recorded.
- 21:10 @ ad28d87 — Index patch draft committed.
- 22:09 @ 8f7ffab — Missing RPC definitions captured; status/log snapshot (git status: M docs/explain-2026-01-19.md, M docs/todaywork.md).

---

## Appendix A — RPC Calls (from Task A scan)

| RPC name | Args | Call site | Expected return | Notes |
| -------- | ---- | --------- | ----------------| ----- |
| get_expiry_warning_days | none | settings:434; products list:555; product detail:854 | number | Defaults locally if null. |
| admin_list_user_profiles | none | settings:475,789 | rows (user_id, display_name, role, active/is_active, created_at) | Admin staff list. |
| set_expiry_warning_days | {p_days} | settings:538 | void | Validates 1~365 client-side. |
| admin_set_user_active | {p_user_id,p_is_active} | settings:581 | void | Toggles active; error-mapped. |
| admin_set_user_display_name | {p_user_id,p_display_name} | settings:664 | void | Updates display name. |
| restore_product | {p_product_id} | archived:622 | void | Reloads list on success. |
| delete_product | {p_product_id,p_confirm_name} | archived:691 | void | Admin-only with name check. |
| get_inventory_logs_for_product | {p_product_id,p_limit} | product detail:765,932 | rows (id, created_at, delta, before_stock, after_stock, actor_name, created_by, note) | Limit 50. |
| update_product | {p_product_id,...} | product detail:1214 | void | Edits fields via RPC. |
| adjust_stock | {p_product_id,p_delta,p_note} | product detail:1308; new:516 | void | Positive IN, negative OUT; uses RPC only. |
| archive_product | {p_product_id,p_reason} | product detail:1349 | void | Requires reason. |

## Appendix B — Table Access (from Task A scan)

| Table | Filters | Order/limit | Call site | Notes |
| ----- | ------- | ----------- | --------- | ----- |
| users_profile | eq user_id | maybeSingle | lib/auth.ts:19; products:495; settings:402; archived:401; api admin:70 | Session/role checks. |
| users_profile | upsert staff profile | onConflict user_id | api admin:117 | Creates staff profile. |
| zones | active=true / by id / all | order(sort_order[,name]) | product detail:676,937,1268; products:548; new:343; archived:428 | Zone chips/options. |
| products | active=true list; active=true detail; active=false archived; updates; insert active=true | order(name); maybeSingle | products:550; detail:895,1093,1163; new:492,542; archived:430 | Direct update only for photo_url. |
| inventory | eq product_id detail; full list; insert stock=0 | maybeSingle | detail:761,927; products:554; archived:434; new:505 | No direct stock updates. |
| product-photos (storage) | upload/remove; update photo_url | n/a | detail:1079,1124,1152; new:532,556 | Storage interactions only. |

## Appendix C — RLS, Functions, Indexes (captured)

- RLS: `is_active_user()` on products/inventory/inventory_logs/zones/app_settings selects; admin-only writes on `users_profile` admin ops and `zones`; inventory insert forces stock=0; products update/insert gated by active user.
- Function definitions captured (key ones): `adjust_stock`, `update_product`, `archive_product`, `restore_product`, `delete_product`, `delete_product_admin`, `admin_list_user_profiles`, `admin_set_user_active`, `admin_set_user_display_name`, `get_inventory_logs_for_product`, `get/set_expiry_warning_days`, `is_active_user`, `is_admin`, `list_archived_products`.
- Existing indexes: `inventory_pkey`; `idx_logs_product_created_at`; `idx_logs_zone_created_at`; `inventory_logs_pkey`; `idx_products_zone_active`; `products_pkey`.

## Appendix D — EXPLAIN Queries (run in SQL Editor)

- Pattern A BEFORE/AFTER:
```sql
explain (analyze, buffers)
select id, name, manufacturer, zone_id, expiry_date, photo_url, unit
from public.products
where active = true
order by name;
```
- Pattern B BEFORE/AFTER:
```sql
explain (analyze, buffers)
select id, name, manufacturer, zone_id
from public.products
where active = false
order by name;
```
- Pattern C BEFORE/AFTER (replace :product_id):
```sql
explain (analyze, buffers)
select id, created_at, delta, before_stock, after_stock, note, created_by
from public.inventory_logs
where product_id = :product_id
order by created_at desc
limit 50;
```
- All outputs: awaiting SQL Editor execution; paste BEFORE/AFTER under Evidence section above.

## Appendix E — Smoke Test Checklist (NOT RUN)

1) Login gate → expect redirect to `/products` for active user.  
2) Products list load → zone chips + All chip visible; no errors.  
3) Product detail → data and stock visible; back link preserves query.  
4) adjust_stock IN/OUT → stock updates; log entry appears; errors shown on invalid/negative.  
5) Archived list → loads; restore/delete modals function; no unexpected errors.  
6) Settings expiry_warning_days (admin) → save succeeds for admin; blocked for non-admin; value persists.
