# CODEX_RULES.md — Onnuri Inven (Execution Rules)

목적: 이 문서는 Codex/AI가 구현 중 실수하지 않도록, “반드시 지켜야 할 실행 규칙”만 모아둔다.  
기준 문서: docs/SSOT.md (v1.1). SSOT와 충돌하면 SSOT가 우선이다.

---

## 1) 절대 규칙 (Non-Negotiable)

### 재고 변경
- inventory.stock을 직접 update 하지 않는다.
- 재고 변경은 반드시 RPC `public.adjust_stock(p_product_id, p_delta, p_note)`로만 처리한다.
- 출고로 인해 0 미만이 되면 서버에서 실패해야 하며, 프론트는 그 에러를 사용자에게 짧게 안내한다.
- 재고 계산(현재고 산출)을 클라이언트에서 별도로 재계산하지 않는다. 서버 반환값/조회값을 신뢰한다.

### 삭제 금지 / 비활성 운영
- “삭제 UX”를 만들지 않는다.
- 기본은 비활성(archived): `products.active=false` + `archived_reason`(필수).
- “완전 삭제”는 이번 범위 밖이다(관리자 전용, 비활성 목록에서만 가능).

### 상태 유지 / 과기능 금지
- 목록 상태(필터 + 검색)는 URL query params로만 유지한다.
- localStorage로 상태 저장하지 않는다.
- 스크롤 위치 복원 기능은 구현하지 않는다.
- 상세에서 다음/이전 이동은 구현하지 않는다.
- 바코드 시스템은 구현하지 않는다.
- 속성 변경 이력(제품명/제조사 등)은 구현하지 않는다(재고 변화만 로그).

---

## 2) 화면과 동선 규칙 (UX Flow)

### 핵심 동선
- 검색/필터 → 목록 → 제품 클릭 → 상세 → 입고/출고 → 목록 복귀
- 복귀 시 필터 + 검색 상태는 유지되어야 한다(스크롤 복원은 제외).

### 재고 조정 UX 고정
- 상세에서 입고/출고 두 버튼 제공.
- 버튼 클릭 → “양수 숫자 입력” 모달.
- 내부 로직:
  - 입고: delta = +수량
  - 출고: delta = -수량
- “+1/-1 버튼” 방식은 정식 UX가 아니다.

---

## 3) 검색 규칙 (Search)

### 대상 필드
- 제품명(name) / 제조사(manufacturer) / 원산지(origin_country, 입력된 경우)

### 동작
- 부분 포함 검색.
- 다중 토큰 AND.
  - 예: "하림 돈까스" = "하림" 포함 AND "돈까스" 포함

### 구역 토큰 override
- 검색어 토큰에 구역명이 포함되면(냉동1/냉동2/냉장/상온):
  - 그 구역이 우선 적용된다.
  - 버튼 필터 상태와 충돌 시 검색이 필터를 덮어쓴다(override).

---

## 4) UI 시스템 규칙 (Design System)

### 글로벌 룰
- 전체 배경색은 #F9F8F6 고정.
- 모바일 우선(한 손 조작).
- 터치 타깃 최소 44px.
- 과한 애니메이션/장식 금지. 단순하고 빠르게.

### 레이아웃 기본
- TopBar + 본문 + (필요 시) 하단 고정 액션 버튼.
- 리스트 아이템은 카드 전체가 탭 가능해야 한다.
- 재고 숫자는 한눈에 들어오도록 크게.

### 상태 처리
- 로딩: Skeleton UI 사용.
- 에러: 사용자 메시지는 짧게, 개발자 정보는 console.error로 상세 출력.

---

## 5) 데이터 접근 패턴 (Supabase)

### 키/보안
- 클라이언트에서는 Publishable(anon) 키만 사용한다.
- Secret 키는 프론트에 절대 노출하지 않는다.

### 읽기(조회)
- 로그인 사용자만 접근한다(RLS 기반).
- products + inventory + zones를 목록/상세에서 조회한다.
- inactive user는 접근이 차단되어야 한다.

### 쓰기(변경)
- 재고 변경: RPC `adjust_stock`만 허용.
- 제품 비활성: staff도 가능, 비활성 사유 필수.
- 제품 등록/수정: SSOT 범위 내에서만 구현(필수 필드: 제품명/구역/수량).

---

## 6) 작업 방식 (How to work with this repo)

### 스코프 통제
- 한 번에 “한 페이지 또는 한 기능 슬라이스”만 구현한다.
- 관련 없는 파일 리팩터링 금지.
- 새로운 기능 제안이 나오면:
  1) SSOT 업데이트
  2) 그 다음 구현

### 완료 기준(각 슬라이스)
- 최소 수동 테스트 체크리스트를 남긴다.
  - 로그인 → 목록 → 상세 → 입고/출고 → 목록 복귀
  - 출고로 0 미만 실패 케이스 확인
  - 필터 + 검색 상태 유지 확인(URL)

---

## 7) 이번 구현 우선순위 (Reference)

1) 제품목록(홈): 구역 필터 + 토큰 AND 검색 + 구역 토큰 override  
2) 제품상세: 입고/출고 모달 → RPC 호출 → 재고/이력 갱신  
3) 제품등록  
4) 관리자(계정/비활성/로그/기준값)

(상세 우선순위와 제외 항목은 SSOT를 따른다.)
